{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "workos-init-script",
  "type": "registry:lib",
  "title": "WorkOS Init Script",
  "description": "CLI script to scaffold WorkOS AuthKit files.",
  "files": [
    {
      "path": "scripts/workos-init.mjs",
      "content": "#!/usr/bin/env node\nimport fs from 'node:fs'\nimport path from 'node:path'\nimport url from 'node:url'\n\nconst __filename = url.fileURLToPath(import.meta.url)\nconst __dirname = path.dirname(__filename)\nconst projectRoot = process.cwd()\n\nfunction log(msg) {\n  console.log(`[workos-init] ${msg}`)\n}\n\nfunction ensureDir(p) {\n  fs.mkdirSync(p, { recursive: true })\n}\n\nfunction writeFile(dest, content) {\n  ensureDir(path.dirname(dest))\n  fs.writeFileSync(dest, content, 'utf8')\n}\n\nfunction readTemplate(relPath) {\n  // Read templates from the CLI package directory so it works when run in other repos\n  const cliTemplatesPath = path.join(__dirname, '..', 'templates', 'workos', relPath)\n  if (fs.existsSync(cliTemplatesPath)) {\n    return fs.readFileSync(cliTemplatesPath, 'utf8')\n  }\n\n  // Fallback: allow local development reading from current project (useful when running inside this repo)\n  const localTemplatesPath = path.join(projectRoot, 'templates', 'workos', relPath)\n  if (fs.existsSync(localTemplatesPath)) {\n    return fs.readFileSync(localTemplatesPath, 'utf8')\n  }\n\n  throw new Error(`Missing template: templates/workos/${relPath}`)\n}\n\nfunction detectBaseDir() {\n  const srcPath = path.join(projectRoot, 'src')\n  if (fs.existsSync(srcPath) && fs.statSync(srcPath).isDirectory()) return srcPath\n  return projectRoot\n}\n\nfunction detectRouter(baseDir) {\n  const hasApp = fs.existsSync(path.join(baseDir, 'app'))\n  const hasPages = fs.existsSync(path.join(baseDir, 'pages'))\n  if (hasApp) return 'app'\n  if (hasPages) return 'pages'\n  // Default to app router scaffold if neither exists\n  return 'app'\n}\n\nfunction scaffoldAppRouter(baseDir) {\n  const destApp = path.join(baseDir, 'app')\n  ensureDir(destApp)\n\n  // callback route\n  writeFile(path.join(destApp, 'callback', 'route.ts'), readTemplate(path.join('app', 'callback', 'route.ts')))\n  // login route\n  writeFile(path.join(destApp, 'login', 'route.ts'), readTemplate(path.join('app', 'login', 'route.ts')))\n  // logout route\n  writeFile(path.join(destApp, 'logout', 'route.ts'), readTemplate(path.join('app', 'logout', 'route.ts')))\n\n  // middleware in baseDir\n  writeFile(path.join(baseDir, 'middleware.ts'), readTemplate('middleware.ts'))\n\n  // optional components and contexts\n  writeFile(path.join(baseDir, 'components', 'header.tsx'), readTemplate(path.join('components', 'header.tsx')))\n  writeFile(path.join(baseDir, 'contexts', 'UserContext.tsx'), readTemplate(path.join('contexts', 'UserContext.tsx')))\n}\n\nfunction scaffoldPagesRouter(baseDir) {\n  // Limited support notice\n  log('Detected Pages Router. AuthKit Next.js targets App Router; scaffolding basic callback only.')\n  const pagesDir = path.join(baseDir, 'pages')\n  ensureDir(pagesDir)\n  // Place middleware as well — supported for route protection\n  writeFile(path.join(baseDir, 'middleware.ts'), readTemplate('middleware.ts'))\n  // Create API callback route using App Router handler signature is not supported in Pages.\n  // We’ll emit a placeholder file with guidance.\n  const apiAuthDir = path.join(pagesDir, 'api', 'auth')\n  ensureDir(apiAuthDir)\n  writeFile(\n    path.join(apiAuthDir, 'workos-callback.ts'),\n    `// This placeholder exists because @workos-inc/authkit-nextjs is designed for the App Router.\\n` +\n      `// Please migrate to App Router or implement a custom callback using the WorkOS Node SDK.\\n` +\n      `// Docs: https://workos.com/docs/authkit/nextjs\\n`\n  )\n}\n\nfunction run() {\n  // Basic arg support: `install workos-authkit`\n  const [, , cmd, sub] = process.argv\n  if (cmd === 'install' && sub === 'workos-authkit') {\n    log('Scaffolding WorkOS AuthKit files...')\n  } else {\n    log('Scaffolding WorkOS AuthKit files...')\n  }\n\n  const baseDir = detectBaseDir()\n  const router = detectRouter(baseDir)\n  log(`Base directory: ${path.relative(projectRoot, baseDir) || '.'}`)\n  log(`Router detected: ${router}`)\n\n  if (router === 'app') {\n    scaffoldAppRouter(baseDir)\n  } else {\n    scaffoldPagesRouter(baseDir)\n  }\n\n  // Create env file if missing\n  createEnvFile()\n\n  // Try to wrap layout with AuthKitProvider\n  if (router === 'app') {\n    try {\n      wrapLayoutWithProvider(baseDir)\n    } catch (e) {\n      log(`Could not update layout automatically: ${e?.message || e}`)\n    }\n  }\n\n  log('Done. Next steps:')\n  log('- Install @workos-inc/authkit-nextjs')\n  log('- Add WORKOS env vars to .env.local')\n  log('- Configure Redirect URIs in WorkOS dashboard')\n}\n\nfunction createEnvFile() {\n  const envPath = path.join(projectRoot, '.env.local')\n  const required = {\n    WORKOS_CLIENT_ID: 'client_... # from WorkOS dashboard',\n    WORKOS_API_KEY: 'sk_... # from WorkOS dashboard',\n    WORKOS_COOKIE_PASSWORD: 'SET_A_STRONG_PASSWORD_32_CHARS_MIN',\n    NEXT_PUBLIC_WORKOS_REDIRECT_URI: 'http://localhost:3000/callback',\n  }\n  if (!fs.existsSync(envPath)) {\n    const contents = Object.entries(required)\n      .map(([k, v]) => `${k}=\"${v}\"`)\n      .join('\\n') + '\\n'\n    fs.writeFileSync(envPath, contents, 'utf8')\n    log('Created .env.local with WorkOS variables (update values as needed).')\n  } else {\n    // Append missing keys\n    const existing = fs.readFileSync(envPath, 'utf8')\n    let updated = existing\n    for (const [k, v] of Object.entries(required)) {\n      const regex = new RegExp(`^${k}=`, 'm')\n      if (!regex.test(existing)) {\n        updated += `${k}=\"${v}\"\\n`\n      }\n    }\n    if (updated !== existing) {\n      fs.writeFileSync(envPath, updated, 'utf8')\n      log('Updated .env.local with missing WorkOS variables.')\n    }\n  }\n}\n\nfunction wrapLayoutWithProvider(baseDir) {\n  const layoutPath = path.join(baseDir, 'app', 'layout.tsx')\n  if (!fs.existsSync(layoutPath)) throw new Error('layout.tsx not found')\n  const backupPath = layoutPath + '.bak'\n  if (!fs.existsSync(backupPath)) {\n    fs.copyFileSync(layoutPath, backupPath)\n    log('Backed up app/layout.tsx to app/layout.tsx.bak')\n  }\n  let src = fs.readFileSync(layoutPath, 'utf8')\n  if (src.includes('AuthKitProvider')) {\n    log('AuthKitProvider already referenced in layout; skipping wrap.')\n    return\n  }\n  // Add import\n  const importLine = \"import { AuthKitProvider } from '@workos-inc/authkit-nextjs/components'\\n\"\n  if (!src.includes(\"@workos-inc/authkit-nextjs/components\")) {\n    // Insert after first import block\n    const lines = src.split('\\n')\n    let insertIdx = 0\n    while (insertIdx < lines.length && lines[insertIdx].startsWith('import')) insertIdx++\n    lines.splice(insertIdx, 0, importLine.trim())\n    src = lines.join('\\n')\n  }\n  // Wrap {children} inside body with AuthKitProvider\n  src = src.replace(/(<body[\\s\\S]*?>)([\\s\\S]*?)(<\\/body>)/, (m, open, inner, close) => {\n    // If already wrapped, keep as is\n    if (inner.includes('<AuthKitProvider>')) return m\n    const wrapped = inner.replace('{children}', '<AuthKitProvider>{children}</AuthKitProvider>')\n    return open + wrapped + close\n  })\n  fs.writeFileSync(layoutPath, src, 'utf8')\n  log('Wrapped layout children with <AuthKitProvider>.')\n}\n\ntry {\n  run()\n} catch (err) {\n  console.error('[workos-init] Error:', err?.message || err)\n  process.exitCode = 1\n}",
      "type": "registry:lib",
      "target": "scripts/workos-init.mjs"
    }
  ]
}